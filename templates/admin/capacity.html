{% extends "base.html" %}

{% block title %}Production Capacity Management{% endblock %}

{% block navbar_title %}âš¡ Production Capacity{% endblock %}

{% block nav_links %}
<a href="/admin">Admin Panel</a>
<a href="/dashboard">Dashboard</a>
<a href="/logout">Logout</a>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
    .capacity-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
    }
    .form-card {
        background: var(--bg-secondary);
        padding: 25px;
        border-radius: 10px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-primary);
    }
    .form-card h2 {
        margin-top: 0;
        margin-bottom: 20px;
        color: var(--text-primary);
    }
    @media (max-width: 900px) {
        .capacity-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="header-card">
    <h1>Production Capacity Management</h1>
    <p>Define the output capacity for each production line per shift.</p>
</div>

<div id="alerts"></div>

<div class="capacity-grid">
    <div>
        <div class="data-table">
            {% if capacities %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Facility</th>
                        <th>Production Line</th>
                        <th>Capacity per Shift</th>
                        <th>Unit</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in capacities %}
                    <tr>
                        <td>{{ item.facility_name }}</td>
                        <td><strong>{{ item.line_name }}</strong></td>
                        <td>{{ "{:,.0f}".format(item.capacity_per_shift) }}</td>
                        <td>{{ item.unit }}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="deleteCapacity({{ item.capacity_id }})">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <h3>No Capacities Defined</h3>
                <p>Use the form to add the first production line capacity.</p>
            </div>
            {% endif %}
        </div>
    </div>
    <div class="form-card">
        <h2>Add or Update Capacity</h2>
        <form id="capacityForm">
            <div class="form-group">
                <label for="line_id">Production Line</label>
                <select id="line_id" name="line_id" class="form-select" required>
                    <option value="">Select a line...</option>
                    {% for line in available_lines %}
                    <option value="{{ line.line_id }}">{{ line.facility_name }} - {{ line.line_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="capacity_per_shift">Capacity per Shift</label>
                <input type="number" id="capacity_per_shift" name="capacity_per_shift" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="unit">Unit</label>
                <input type="text" id="unit" name="unit" class="form-control" value="sticks" placeholder="e.g., sticks, units, bottles">
            </div>
            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea id="notes" name="notes" class="form-control" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Save Capacity</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('capacityForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = {
            line_id: document.getElementById('line_id').value,
            capacity_per_shift: document.getElementById('capacity_per_shift').value,
            unit: document.getElementById('unit').value,
            notes: document.getElementById('notes').value,
        };

        fetch('/admin/capacity/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            dtUtils.showAlert(data.message, data.success ? 'success' : 'error');
            if (data.success) {
                setTimeout(() => location.reload(), 1000);
            }
        });
    });

    function deleteCapacity(capacityId) {
        if (confirm('Are you sure you want to delete this capacity setting?')) {
            fetch('/admin/capacity/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ capacity_id: capacityId })
            })
            .then(response => response.json())
            .then(data => {
                dtUtils.showAlert(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    setTimeout(() => location.reload(), 1000);
                }
            });
        }
    }
</script>
{% endblock %}