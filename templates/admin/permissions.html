{% extends "base.html" %}

{% block title %}User Permissions - Admin Panel{% endblock %}

{% block navbar_title %}üîë User Permissions{% endblock %}

{% block nav_links %}
<a href="/admin">Admin Panel</a>
<a href="/dashboard">Dashboard</a>
<a href="/logout">Logout</a>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
    /* Page-specific styles */
    .permissions-table th, .permissions-table td {
        vertical-align: middle;
        padding: 10px 15px; /* Adjust padding */
    }
    .permissions-table thead th {
        text-align: center;
        white-space: normal; /* Allow header text to wrap */
        font-size: 13px;
    }
    .permissions-table tbody td {
        text-align: center;
        font-size: 14px;
    }
    .permissions-table td:first-child {
        text-align: left;
        font-weight: 500;
    }
    .permissions-table .user-info-cell {
         display: flex;
         align-items: center;
         gap: 10px;
    }
    .permissions-table .user-avatar {
        width: 32px; height: 32px; border-radius: 50%; background: var(--gradient-primary);
        color: white; display: flex; align-items: center; justify-content: center;
        font-weight: 600; font-size: 14px; flex-shrink: 0;
    }
    .permissions-table .user-details {
        display: flex;
        flex-direction: column;
    }
     .permissions-table .user-name {
        font-weight: 600; color: var(--text-primary);
    }
    .permissions-table .user-email {
        font-size: 12px; color: var(--text-tertiary);
    }
    .permission-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    /* Add specific styles for AD group display */
    .ad-groups-cell {
        font-size: 11px;
        color: var(--text-tertiary);
        text-align: left;
        max-width: 200px; /* Limit width */
        white-space: normal; /* Allow wrapping */
    }
    .ad-groups-cell .group-tag {
        font-size: 10px;
        padding: 2px 6px;
        margin: 1px;
    }
    .search-bar { /* Reuse search bar style */
        position: relative; margin-bottom: 20px;
    }
    .search-input {
        width: 100%; padding: 12px 16px 12px 40px; border: 2px solid var(--input-border);
        border-radius: 8px; font-size: 14px; background: var(--input-bg); color: var(--text-primary);
    }
    .search-icon {
        position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary);
    }
    .saving-indicator {
        display: inline-block; width: 16px; height: 16px;
        border: 2px solid #ccc; border-top-color: var(--accent-blue);
        border-radius: 50%; animation: spin 1s linear infinite;
        margin-left: 5px; vertical-align: middle; display: none; /* Hidden by default */
    }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<div class="header-card">
    <h1>Manage User Permissions</h1>
    <p>Grant specific access rights to users beyond their standard AD group permissions.</p>
</div>

<div id="alerts"></div>

<div class="search-bar">
    <span class="search-icon">üîç</span>
    <input type="text" class="search-input" id="userSearch"
           placeholder="Search by username, name, or email..."
           onkeyup="filterUsers()">
</div>

<div class="data-table">
    {% if all_users_permissions %}
    <table class="table permissions-table">
        <thead>
            <tr>
                <th style="text-align: left;">User</th>
                <th style="text-align: left;">AD Groups / Base Role</th>
                <th>View Scheduling</th>
                <th>Edit Scheduling</th>
                <th>Enter Downtime</th>
                <th>View Reports</th>
                </tr>
        </thead>
        <tbody id="permissionsTableBody">
            {% for p_user in all_users_permissions %}
            <tr data-username="{{ p_user.username }}">
                <td>
                    <div class="user-info-cell">
                         <div class="user-avatar">{{ p_user.username[0].upper() }}</div>
                         <div class="user-details">
                             <span class="user-name">{{ p_user.display_name or p_user.username }}</span>
                             <span class="user-email">{{ p_user.email or 'No email' }}</span>
                         </div>
                    </div>
                </td>
                 <td class="ad-groups-cell">
                     {# Display simplified base role based on AD group flags #}
                     {% if p_user.is_admin %} <span class="group-tag highlight">Base: Admin</span>
                     {% elif p_user.is_scheduling_admin %} <span class="group-tag highlight">Base: Sched Admin</span>
                     {% elif p_user.is_scheduling_user %} <span class="group-tag highlight">Base: Sched User</span>
                     {% elif p_user.is_user %} <span class="group-tag highlight">Base: Downtime User</span>
                     {% else %} <span class="group-tag">Base: None</span>
                     {% endif %}
                 </td>
                <td><input type="checkbox" class="permission-checkbox" data-permission="can_view_scheduling" {% if p_user.can_view_scheduling %}checked{% endif %}></td>
                <td><input type="checkbox" class="permission-checkbox" data-permission="can_edit_scheduling" {% if p_user.can_edit_scheduling %}checked{% endif %}></td>
                <td><input type="checkbox" class="permission-checkbox" data-permission="can_view_downtime" {% if p_user.can_view_downtime %}checked{% endif %}></td>
                <td><input type="checkbox" class="permission-checkbox" data-permission="can_view_reports" {% if p_user.can_view_reports %}checked{% endif %}></td>
                <td><span class="saving-indicator"></span></td> {# Indicator column #}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <h3>No User Data Found</h3>
        <p>No users have logged into the system yet, or there was an error fetching data.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    function filterUsers() {
        const searchTerm = document.getElementById('userSearch').value.toLowerCase();
        const rows = document.querySelectorAll('#permissionsTableBody tr');

        rows.forEach(row => {
            const username = row.dataset.username.toLowerCase();
            const name = row.querySelector('.user-name')?.textContent.toLowerCase() || '';
            const email = row.querySelector('.user-email')?.textContent.toLowerCase() || '';
            const rowText = `${username} ${name} ${email}`;
            row.style.display = rowText.includes(searchTerm) ? '' : 'none';
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const tableBody = document.getElementById('permissionsTableBody');
        if (tableBody) {
            tableBody.addEventListener('change', function(event) {
                if (event.target.classList.contains('permission-checkbox')) {
                    handlePermissionChange(event.target);
                }
            });
        }
        // Initial filter call in case search input has persisted value
        filterUsers();
    });

    // Debounce function to limit API calls
    const debounce = (func, delay) => {
        let timeoutId;
        return function(...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                func.apply(this, args);
            }, delay);
        };
    };

    const handlePermissionChange = debounce((checkbox) => {
        const row = checkbox.closest('tr');
        const username = row.dataset.username;
        const savingIndicator = row.querySelector('.saving-indicator');
        savingIndicator.style.display = 'inline-block'; // Show spinner

        // Collect all permissions for this user from the row
        const permissions = {};
        row.querySelectorAll('.permission-checkbox').forEach(cb => {
            permissions[cb.dataset.permission] = cb.checked;
        });

        // Send update to the server
        fetch('/admin/permissions/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Add CSRF token header if needed
            },
            body: JSON.stringify({
                username: username,
                permissions: permissions
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Optionally show a temporary success indicator (e.g., green check)
                dtUtils.showAlert(`Permissions updated for ${username}`, 'success');
            } else {
                // Revert checkbox state on failure
                checkbox.checked = !checkbox.checked;
                dtUtils.showAlert(`Error updating permissions for ${username}: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Revert checkbox state on network error
            checkbox.checked = !checkbox.checked;
            dtUtils.showAlert(`Network error updating permissions for ${username}.`, 'error');
        })
        .finally(() => {
             savingIndicator.style.display = 'none'; // Hide spinner
        });
    }, 500); // Debounce saves by 500ms

</script>
{% endblock %}